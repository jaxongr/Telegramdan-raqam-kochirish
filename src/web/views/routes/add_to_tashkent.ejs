<!DOCTYPE html>
<html lang="uz">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Viloyatlardan Toshkentga - Telegram SMS Tizim</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    .sidebar {
      min-height: 100vh;
      background: #212529;
    }
    .sidebar .nav-link {
      color: #adb5bd;
      padding: 0.8rem 1rem;
    }
    .sidebar .nav-link:hover, .sidebar .nav-link.active {
      color: #fff;
      background: #343a40;
    }
    .region-checkbox {
      display: none;
    }
    .region-label {
      display: block;
      padding: 15px 20px;
      margin: 10px 0;
      background: #f8f9fa;
      border: 3px solid #dee2e6;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s;
      font-size: 18px;
      font-weight: 500;
    }
    .region-label:hover {
      background: #e9ecef;
      border-color: #198754;
      transform: translateX(5px);
    }
    .region-checkbox:checked + .region-label {
      background: #198754;
      color: white;
      border-color: #198754;
    }
    .region-checkbox:checked + .region-label i {
      display: inline;
    }
    .region-label i {
      display: none;
    }
  </style>
</head>
<body>
  <div class="container-fluid">
    <div class="row">
      <!-- Sidebar -->
      <nav class="col-md-2 d-md-block sidebar">
        <div class="position-sticky pt-3">
          <h5 class="text-white px-3 mb-3">
            <i class="bi bi-telegram"></i> Telegram SMS
          </h5>
          <ul class="nav flex-column">
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="bi bi-speedometer2"></i> Bosh sahifa
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/groups">
                <i class="bi bi-collection"></i> Guruhlar
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/phones">
                <i class="bi bi-telephone"></i> Telefon raqamlar
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/sms">
                <i class="bi bi-chat-dots"></i> SMS loglar
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/semysms">
                <i class="bi bi-sim"></i> SemySMS raqamlar
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/history">
                <i class="bi bi-clock-history"></i> Eski xabarlar
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/history/results">
                <i class="bi bi-archive"></i> Arxiv natijalar
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/settings">
                <i class="bi bi-gear"></i> Sozlamalar
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link active" href="/routes">
                <i class="bi bi-signpost"></i> Yo'nalishlar
              </a>
            </li>
          </ul>
          <hr class="text-white">
          <div class="px-3">
            <small class="text-muted">Foydalanuvchi: <%= username %></small><br>
            <a href="/logout" class="btn btn-sm btn-outline-light mt-2">
              <i class="bi bi-box-arrow-right"></i> Chiqish
            </a>
          </div>
        </div>
      </nav>

      <!-- Main content -->
      <main class="col-md-10 ms-sm-auto px-md-4">
        <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
          <h1 class="h2">
            <a href="/routes/add" class="text-decoration-none text-muted">
              <i class="bi bi-arrow-left"></i>
            </a>
            <i class="bi bi-arrow-left-circle text-success"></i>
            Viloyatlardan Toshkentga
          </h1>
          <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addRegionModal">
            <i class="bi bi-plus-circle"></i> Yangi viloyat qo'shish
          </button>
        </div>

        <div class="alert alert-success mb-4">
          <h5><i class="bi bi-info-circle"></i> Qaysi viloyatlardan Toshkentga yo'nalish qo'shmoqchisiz?</h5>
          <p class="mb-0">Kerakli viloyatlarni belgilang (bir nechta tanlash mumkin)</p>
        </div>

        <form method="POST" action="/routes/add/to-tashkent">
          <div class="row">
            <div class="col-md-6">
              <input type="checkbox" class="region-checkbox" id="andijon" name="regions" value="andijon">
              <label for="andijon" class="region-label">
                <i class="bi bi-check-circle-fill me-2"></i>
                Andijon viloyati
              </label>

              <input type="checkbox" class="region-checkbox" id="buxoro" name="regions" value="buxoro">
              <label for="buxoro" class="region-label">
                <i class="bi bi-check-circle-fill me-2"></i>
                Buxoro viloyati
              </label>

              <input type="checkbox" class="region-checkbox" id="fargona" name="regions" value="fargona">
              <label for="fargona" class="region-label">
                <i class="bi bi-check-circle-fill me-2"></i>
                Farg'ona viloyati
              </label>

              <input type="checkbox" class="region-checkbox" id="jizzax" name="regions" value="jizzax">
              <label for="jizzax" class="region-label">
                <i class="bi bi-check-circle-fill me-2"></i>
                Jizzax viloyati
              </label>

              <input type="checkbox" class="region-checkbox" id="xorazm" name="regions" value="xorazm">
              <label for="xorazm" class="region-label">
                <i class="bi bi-check-circle-fill me-2"></i>
                Xorazm viloyati
              </label>

              <input type="checkbox" class="region-checkbox" id="namangan" name="regions" value="namangan">
              <label for="namangan" class="region-label">
                <i class="bi bi-check-circle-fill me-2"></i>
                Namangan viloyati
              </label>
            </div>

            <div class="col-md-6">
              <input type="checkbox" class="region-checkbox" id="navoiy" name="regions" value="navoiy">
              <label for="navoiy" class="region-label">
                <i class="bi bi-check-circle-fill me-2"></i>
                Navoiy viloyati
              </label>

              <input type="checkbox" class="region-checkbox" id="qashqadaryo" name="regions" value="qashqadaryo">
              <label for="qashqadaryo" class="region-label">
                <i class="bi bi-check-circle-fill me-2"></i>
                Qashqadaryo viloyati
              </label>

              <input type="checkbox" class="region-checkbox" id="qoraqalpogiston" name="regions" value="qoraqalpogiston">
              <label for="qoraqalpogiston" class="region-label">
                <i class="bi bi-check-circle-fill me-2"></i>
                Qoraqalpog'iston
              </label>

              <input type="checkbox" class="region-checkbox" id="samarqand" name="regions" value="samarqand">
              <label for="samarqand" class="region-label">
                <i class="bi bi-check-circle-fill me-2"></i>
                Samarqand viloyati
              </label>

              <input type="checkbox" class="region-checkbox" id="sirdaryo" name="regions" value="sirdaryo">
              <label for="sirdaryo" class="region-label">
                <i class="bi bi-check-circle-fill me-2"></i>
                Sirdaryo viloyati
              </label>

              <input type="checkbox" class="region-checkbox" id="surxondaryo" name="regions" value="surxondaryo">
              <label for="surxondaryo" class="region-label">
                <i class="bi bi-check-circle-fill me-2"></i>
                Surxondaryo viloyati
              </label>
            </div>
          </div>

          <div class="mt-4">
            <button type="submit" class="btn btn-success btn-lg">
              <i class="bi bi-plus-circle"></i> Tanlangan viloyatlarni qo'shish
            </button>
            <a href="/routes/add" class="btn btn-secondary btn-lg ms-2">
              <i class="bi bi-x-circle"></i> Bekor qilish
            </a>
          </div>
        </form>
      </main>
    </div>
  </div>

  <!-- Modal: Yangi viloyat qo'shish -->
  <div class="modal fade" id="addRegionModal" tabindex="-1" aria-labelledby="addRegionModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title" id="addRegionModalLabel">
            <i class="bi bi-geo-alt-fill"></i> Yangi viloyat qo'shish
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="alert alert-info">
            <i class="bi bi-info-circle"></i>
            Yangi viloyat nomini kiriting va unga tegishli yo'nalishlarni qo'shing
          </div>

          <form id="newRegionForm">
            <!-- Viloyat nomi -->
            <div class="mb-3">
              <label for="regionName" class="form-label fw-bold">
                <i class="bi bi-geo-alt"></i> Viloyat nomi:
              </label>
              <input
                type="text"
                class="form-control form-control-lg"
                id="regionName"
                name="regionName"
                placeholder="Masalan: Sirdaryo viloyati"
                required
              >
              <small class="text-muted">To'liq nom kiriting (viloyati so'zi bilan)</small>
            </div>

            <!-- Kalit so'zlar -->
            <div class="mb-3">
              <label for="keywords" class="form-label fw-bold">
                <i class="bi bi-tags-fill"></i> Kalit so'zlar (keywords):
              </label>
              <textarea
                class="form-control"
                id="keywords"
                name="keywords"
                rows="4"
                placeholder="Har bir kalit so'zni yangi qatorga kiriting, masalan:
Sirdaryo
sirdaryo
Sirdaryo viloyati
SIRDARYO"
                required
              ></textarea>
              <small class="text-muted">Har bir kalit so'z alohida qatordan boshlanishi kerak</small>
            </div>

            <!-- SMS template -->
            <div class="mb-3">
              <label for="smsTemplate" class="form-label fw-bold">
                <i class="bi bi-chat-dots-fill"></i> SMS xabar shabloni:
              </label>
              <textarea
                class="form-control"
                id="smsTemplate"
                name="smsTemplate"
                rows="3"
                placeholder="Masalan: Sirdaryo → Toshkent"
                required
              ></textarea>
              <small class="text-muted">Bu xabar SMS da yuboriladi</small>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            <i class="bi bi-x-circle"></i> Bekor qilish
          </button>
          <button type="button" class="btn btn-success" onclick="saveNewRegion()">
            <i class="bi bi-check-circle"></i> Saqlash
          </button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    function saveNewRegion() {
      const regionName = document.getElementById('regionName').value.trim();
      const keywords = document.getElementById('keywords').value.trim();
      const smsTemplate = document.getElementById('smsTemplate').value.trim();

      if (!regionName || !keywords || !smsTemplate) {
        alert('Iltimos, barcha maydonlarni to\'ldiring!');
        return;
      }

      // Keywords ni array ga aylantirish
      const keywordsArray = keywords.split('\n')
        .map(k => k.trim())
        .filter(k => k.length > 0);

      if (keywordsArray.length === 0) {
        alert('Kamida bitta kalit so\'z kiriting!');
        return;
      }

      // Ma'lumotlarni serverga yuborish
      fetch('/routes/add/custom-region', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          regionName: regionName,
          keywords: keywordsArray,
          smsTemplate: smsTemplate,
          direction: 'to-tashkent' // Toshkentga yo'nalish
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          alert('Yangi viloyat muvaffaqiyatli qo\'shildi!');
          // Modalni yopish
          const modal = bootstrap.Modal.getInstance(document.getElementById('addRegionModal'));
          modal.hide();
          // Sahifani yangilash
          location.reload();
        } else {
          alert('Xatolik: ' + (data.error || 'Noma\'lum xatolik'));
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('Serverga ulanishda xatolik!');
      });
    }
  </script>
</body>
</html>
